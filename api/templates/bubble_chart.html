<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinNarratives</title>
    <!-- Include jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Include Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Include D3 library -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>

    <h1>Token Narratives</h1>

    <h2>Market Overview</h2>
    <div id="overall-chart"></div>
    <h2>Individual Categories</h2>
    <div id="rwa-chart"></div>
    <div id="defi-chart"></div>
    <div id="l2-chart"></div>
    <div id="l1-chart"></div>
    <div id="meme-chart"></div>

    <script>
        // Make an AJAX request to fetch data from the server
        $.ajax({
            url: '/get_data',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                // Extract data for each category and the overall market from the response
                var categoriesData = response.categories;
                var overallMarketData = response.overall_market;

                // Process data for each category
                Object.keys(categoriesData).forEach(function(category) {
                    var categoryData = categoriesData[category];
                    // Process category data and generate bubble chart
                    generateTreemap(category, categoryData);
                });

                // Collect data for all categories
                var overallMarketDataArray = [];
                // Process overall market data for each category
                Object.keys(overallMarketData).forEach(function(category) {
                    var overallMarketVolume = overallMarketData[category].usd_24h_vol;
                    var overallMarketChange = overallMarketData[category].weighted_24h_change;
                    
                    // Collect category, volume, and change data for each category
                    var categoryData = {
                        category: category,
                        volume: overallMarketVolume,
                        change: overallMarketChange
                    };
                    
                    overallMarketDataArray.push(categoryData);
                });

                // Generate overall market bubble chart using consolidated data
                generateOverallMarketBubbleChart(overallMarketDataArray);
            },
            error: function(xhr, status, error) {
                // Handle error
                console.error('Error fetching data:', error);
            }
        });

        // Function to generate a treemap for a specific category
        function generateTreemap(category, data) {
            // Implement treemap generation logic using the data for the specified category
            console.log('Generating treemap for category:', category);
            const dataArray = Object.entries(data);
            var labels = [];
            var parents = [];
            var values = [];
            var colors = [];
            var customdata = [];

            // Extract 24hr change values from the token data
            const changeValues = dataArray.map(([tokenName, tokenData]) => tokenData.usd_24h_change);
            const minChange = Math.min(...changeValues);
            const maxChange = Math.max(...changeValues);

            // Iterate over each inner array in the data array
            dataArray.forEach(function(innerArray) {
                const tokenName = innerArray[0]; // Token name is at index 0
                const tokenData = innerArray[1]; // Token data is at index 1

                // Extract specific data fields from the token data object
                const token_usd_24h_change = tokenData.usd_24h_change;
                const token_usd_24h_vol = tokenData.usd_24h_vol;

                // Construct labels, values, and colors for the treemap
                labels.push(tokenName); // Token name without the change in the label
                values.push(token_usd_24h_vol);
                parents.push(""); // Since it's a single-level treemap, all tokens have an empty parent
                customdata.push([token_usd_24h_vol, token_usd_24h_change]); // Store custom data for hover template

                // Define the color scale function with light green, light red, and white undertones
                const colorScale = d3.scaleLinear()
                    .domain([minChange, 0, maxChange])  // Include 0 for white undertone
                    .range(["red", "white", "green"]);  // Adjust colors as needed

                // Determine color based on the price change value relative to the range of changes
                const color = colorScale(token_usd_24h_change);
                colors.push(color);

            });

            // Define hover template
            var hoverTemplate = '<b>%{label}</b><br>' +
                                'Volume: $%{customdata[0]:,.2f}<br>' +
                                'Change: %{customdata[1]:.2f}%';

            // Define data for the treemap
            var data = [{
                type: "treemap",
                labels: labels,
                parents: parents,
                values: values,
                customdata: customdata,
                marker: {
                    colors: colors, // Assign colors based on the price change values
                },
                hovertemplate: hoverTemplate
            }];

            // Define layout for the treemap
            var layout = {
                title: `Overview for ${category}`,
                hovermode: "closest", // Show hover labels for closest point
                hoverlabel: {
                    bgcolor: "white", // Set background color for hover labels
                    bordercolor: "black", // Set border color for hover labels
                    font: {
                        family: "Arial", // Set font family for hover labels
                        size: 12, // Set font size for hover labels
                        color: "black" // Set font color for hover labels
                    }
                }
            };

            // Plot the treemap
            Plotly.newPlot(`${category}-chart`, data, layout);
        }

        // Function to generate a bubble chart for the overall market
        function generateOverallMarketBubbleChart(overallMarketDataArray) {
            // Implement bubble chart generation logic using the overall market data
            console.log('Generating bubble chart for overall market', overallMarketDataArray);

            // Extract data for plotting
            var volumes = overallMarketDataArray.map(function(data) {
                return data.volume;
            });

            var changes = overallMarketDataArray.map(function(data) {
                return data.change;
            });

            var categories = overallMarketDataArray.map(function(data) {
                return data.category;
            });

            // Define trace for the overall market bubble chart
            var trace = {
                x: volumes,
                y: changes,
                mode: 'markers',
                marker: {
                    size: volumes, // Adjust marker size based on volume
                    sizemode: 'area', // Set the sizemode to 'area'
                    sizeref: 2.0 * Math.max(...volumes) / (50 ** 2), // Adjust the sizeref for better scaling
                    sizemin: 4, // Minimum size of bubbles
                    color: 'blue', // Set marker color
                    opacity: 0.8 // Set marker opacity
                },
                text: categories, // Use category names for hover text
            };

            // Define layout for the overall market bubble chart
            var layout = {
                title: 'Overall Market Summary',
                xaxis: {
                    title: 'Total Volume (USD)',
                    type: 'log' // Set x-axis type to log
                },
                yaxis: {
                    title: 'Weighted 24hr Change (%)'
                }
            };

            // Plot the bubble chart for the overall market
            Plotly.newPlot('overall-chart', [trace], layout);
        }
    </script>

</body>
</html>
